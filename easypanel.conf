# Configuración específica para EasyPanel con Traefik
# Este archivo debe ser colocado en el directorio raíz de la aplicación

# Configuración de Apache para EasyPanel
<VirtualHost *:80>
    DocumentRoot /var/www/html
    ServerName agentex-sam.iejhy7.easypanel.host
    
    # Configuración de directorios
    <Directory /var/www/html>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Configuración específica para Yii2
        DirectoryIndex index.php
        
        # Habilitar reescritura de URLs
        RewriteEngine On
        
        # Manejar headers de Traefik
        RewriteCond %{HTTP:X-Forwarded-Proto} https
        RewriteRule .* - [E=HTTPS:on]
        
        # Configurar variables de entorno para proxy
        SetEnvIf X-Forwarded-Proto https HTTPS=on
        SetEnvIf X-Forwarded-For ^(.*)$ REMOTE_ADDR=$1
        
        # Reglas de reescritura para Yii2
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . index.php [L]
    </Directory>
    
    # Configuración de logs
    ErrorLog ${APACHE_LOG_DIR}/isurgob_error.log
    CustomLog ${APACHE_LOG_DIR}/isurgob_access.log combined
    
    # Configuración de PHP
    php_admin_value upload_max_filesize 10M
    php_admin_value post_max_size 10M
    php_admin_value max_execution_time 300
    php_admin_value max_input_time 300
    php_admin_value memory_limit 256M
    php_admin_value session.gc_maxlifetime 3600
    
    # Headers de seguridad compatibles con Traefik
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options SAMEORIGIN
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Configuración para proxy reverso
    RemoteIPHeader X-Forwarded-For
    RemoteIPTrustedProxy 10.0.0.0/8
    RemoteIPTrustedProxy 172.16.0.0/12
    RemoteIPTrustedProxy 192.168.0.0/16
    
    # Configuración de compresión
    <IfModule mod_deflate.c>
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \\
            \.(?:gif|jpe?g|png)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \\
            \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
    </IfModule>
</VirtualHost>

# Configuración HTTPS (si está disponible)
<IfModule mod_ssl.c>
<VirtualHost *:443>
    DocumentRoot /var/www/html
    ServerName agentex-sam.iejhy7.easypanel.host
    
    # Configuración SSL manejada por Traefik
    SSLEngine off
    
    # Misma configuración que HTTP
    <Directory /var/www/html>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        DirectoryIndex index.php
        
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . index.php [L]
    </Directory>
    
    # Headers específicos para HTTPS
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    ErrorLog ${APACHE_LOG_DIR}/isurgob_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/isurgob_ssl_access.log combined
</VirtualHost>
</IfModule>